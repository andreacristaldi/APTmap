<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1" />
  <meta name="description" content="APTMAP - Advanced Persistent Threat Map">
  <meta name="keywords" content="APTMAP, Advanced Persistent Threat Map">
  <meta name="author" content="Andrea Cristaldi">
  <title>APTMAP - Advanced Persistent Threat Map</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="CSS/style.css" />
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <script src="https://js.arcgis.com/4.27/"></script>
  
  
 <script>

 function toggleAPTDetails(h2Element) {
        var details = h2Element.nextElementSibling;
        details.classList.toggle("opendetails");
    }
 
var jdata;

async function fetchData() {
  try {
    const response = await fetch('apt.json');
    jdata = await response.json();

    if (jdata.hasOwnProperty("features")) {
      console.log("JSON OK");
    } else {
      console.log("JSON ERROR");
    }
  } catch (error) {
    console.log('JSON error: ', error);
  }
}

fetchData().then(() => {




    window.addEventListener('hashchange', function(){
	document.getElementById("search").click();
	document.getElementById("searchAPTname").value="";
	document.getElementById("searchTarget").value="";
	document.getElementById("searchTargetcategory").value="";
	document.getElementById("searchTool").value="";
	document.getElementById("searchLocation").value="";
	
	if (window.location.hash!==""|| window.location.hash!=="#"){
		for (var h of window.location.hash.split("#")[1].split("&")){
		
			if (h.split("=")[0]==="name"){
				document.getElementById("searchAPTname").value=decodeURIComponent(h.split("=")[1]);
			}
			if (h.split("=")[0]==="target"){
				document.getElementById("searchTarget").value=decodeURIComponent(h.split("=")[1]);
			}
			if (h.split("=")[0]==="targetcategory"){
				document.getElementById("searchTargetcategory").value=decodeURIComponent(h.split("=")[1]);
			}
			if (h.split("=")[0]==="tool"){
				document.getElementById("searchTool").value=decodeURIComponent(h.split("=")[1]);
			}
			if (h.split("=")[0]==="location"){
				document.getElementById("searchLocation").value=decodeURIComponent(h.split("=")[1]);
			}
		}
	
	Search();
	}
	
});
 
function GetDate()
{

	var today = new Date();
	var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
	var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
	var dateTime = date+' '+time;
	var date2 = new Date(dateTime);

	return date2.toString();
}

function GetMap()
{
	var today = new Date();

	if (today.getHours()>=0 && today.getHours()<17){
		return 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer';
	}
	else{
		return 'https://tiles.arcgis.com/tiles/P3ePLMYs2RVChkJx/arcgis/rest/services/Earth_at_Night_2016/MapServer';
	}
			 
}
	

    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/TileLayer",
      "esri/layers/GeoJSONLayer",
      "esri/Basemap",
      "esri/Graphic",
      "esri/geometry/Point",
      "esri/geometry/Mesh",
	  "esri/core/reactiveUtils"
   
    ], function (Map, SceneView, TileLayer, GeoJSONLayer, Basemap,  Graphic, Point, Mesh, reactiveUtils) {



      const R = 6358137; // approximate radius of the Earth in m
      const offset = 300000; // offset from the ground used for the clouds
      const basemap = new Basemap({
        baseLayers: [
          
		  new TileLayer({
            url: GetMap()
          }),
		  new TileLayer({
            url: "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"
			
          })
        ]
      });
      const map = new Map({
        basemap: basemap
      });
      const view = new SceneView({
        container: "viewDiv",
        map: map,
        alphaCompositingEnabled: true,
        qualityProfile: "high",
		rotate: true,
        camera: {
          position: [15.03975781, 14.94826384, 19921223.30821],
          heading: 2.03,
          tilt: 0.13
        },
		
        environment: {
          background: {
            type: "color",
            color: [255, 252, 244, 0]
          },
          starsEnabled: true,
          atmosphereEnabled: true,
          lighting: {
            directShadowsEnabled: false,
            date: "Sun Jun 23 2019 18:00:00 GMT+0200 (Central European Summer Time)"//GetDate()
          }
        },
        constraints: {
          altitude: {
            min: 5000000,
            max: 35000000
          }
        },
        popup: {
          dockEnabled: true,
          dockOptions: {
            position: "top-right",
            breakpoint: false,
            buttonEnabled: false
          },
          collapseEnabled: false
        },
        highlightOptions: {
          color: [255, 255, 0],
          haloOpacity: 0.8
        }
      });

      view.ui.empty("top-left");
     
      const origin = new Point({
        x: 0, y: -90, z: -(2 * R)
      });
      
      
	  

      const extremesLayer = new GeoJSONLayer({
	    id: "extremesLayer",
        url: "apt.json",
        elevationInfo: {
          mode: "absolute-height",
          offset: offset
        }, 
		outFields: ["*"],
		
        renderer: {
          type: "simple",
          symbol: {
            type: "point-3d",
            symbolLayers: [{
              type: "icon",
              resource: { primitive: "circle" },
              material: { color: [0, 0, 0, 0] },
              outline: { color: [245, 99, 66, 1], size: 4 },
              size: 4
            }, {
              type: "icon",
              resource: { primitive: "circle" },
              material: { color: [0, 0, 0, 0] },
              outline: { color: [255, 0, 0, 1], size: 2 },
              size: 10
            }]
          }
        },
        popupTemplate: {
          title: "{name}",
		  content: DisplayPopUp,
		  outFields: ["*"],
		  /*autoCloseEnabled: false*/
	      }
	
      });
map.layers.add(extremesLayer);


reactiveUtils.watch(
  () => view.popup.visible,
  (graphic) => {
    if (graphic) {
        document.getElementById("chart-container").style.maxWidth = "50%";
    } else {
        document.getElementById("chart-container").style.maxWidth = "100%";
    }
  }
);


if (!view.interacting) {
        const camera = view.camera.clone();
        camera.position.longitude -= 0.2;
        view.goTo(camera, { animate: false });
        requestAnimationFrame(rotate);
        }
    


jdata.features = jdata.features.sort((a, b) => {
  if (a.properties.name < b.properties.name) {
    return -1;
  }
});

	  
function onChart(jdata) {
	var vdict1={};
	var yValues1 = [];
	var xValues1 = [];
	
	var vdict2={};
	var yValues2 = [];
	var xValues2 = [];
	
	var vdict3={};
	var yValues3 = [];
	var xValues3 = [];
	
	var vdict4={};
	var yValues4 = [];
	var xValues4 = [];
	
	var vdict5={};
	var yValues5 = [];
	var xValues5 = [];
	
	var vdict6={};
	var yValues6 = [];
	var xValues6 = [];
	
		
    for (let i = 0; i < jdata.features.length; i++) {
		//chart1
		if (vdict1[jdata.features[i].properties.country] !== undefined)
		{ 
			vdict1[jdata.features[i].properties.country]+=1;
		}
		else {
			vdict1[jdata.features[i].properties.country]=1;
		}

		//chart2
		if (vdict2[jdata.features[i].properties["first-seen"]] !== undefined)
		{ 
			vdict2[jdata.features[i].properties["first-seen"]]+=1;
		}
		else {
			vdict2[jdata.features[i].properties["first-seen"]]=1;
		}
		
		//chart3
		for (let i2 = 0; i2 < jdata.features[i].properties["targets"].length; i2++) {
			if (vdict3[jdata.features[i].properties["targets"][i2]] !== undefined)
			{ 
				vdict3[jdata.features[i].properties["targets"][i2]]+=1;
			}
			else {
				vdict3[jdata.features[i].properties["targets"][i2]]=1;
			}
	
		}

		//chart4
		for (let i3 = 0; i3 < jdata.features[i].properties["target-category"].length; i3++) {
			if (vdict4[jdata.features[i].properties["target-category"][i3]] !== undefined)
			{ 
				vdict4[jdata.features[i].properties["target-category"][i3]]+=1;
			}
			else {
				vdict4[jdata.features[i].properties["target-category"][i3]]=1;
			}

		}

		//chart5 & chart6
		for (let i4 = 0; i4 < jdata.features[i].properties["tools"].length; i4++) {
			if(jdata.features[i].properties["tools"][i4].type!==undefined){
				for (let i5 = 0; i5 < jdata.features[i].properties["tools"][i4].type.length; i5++) {
	
	
					if (vdict5[jdata.features[i].properties["tools"][i4].type[i5]] !== undefined)
						{ 
						vdict5[jdata.features[i].properties["tools"][i4].type[i5]]+=1;
						}
					else {
						vdict5[jdata.features[i].properties["tools"][i4].type[i5]]=1;
						}
				}
			}
			if (vdict6[jdata.features[i].properties["tools"][i4].value] !== undefined)
				{ 
					vdict6[jdata.features[i].properties["tools"][i4].value]+=1;
				}
			else {
					vdict6[jdata.features[i].properties["tools"][i4].value]=1;
				}
				
			
		}
		
		
	}
	
	
	
	
	//chart1
	var vdict1_sort = Object.keys(vdict1).map(function(key) {  return [key, vdict1[key]];});
	vdict1_sort.sort(function(first, second) {  return second[1] - first[1];});


	for (let i = 0; i < 9; i++) {
		if (vdict1_sort[i][0]!==""){
			yValues1.push(vdict1_sort[i][0]);
			xValues1.push(vdict1_sort[i][1]);
			}
	}



    const labels1 = yValues1;
    const data1 = {
                    labels: labels1,
                            datasets: [
                                {
                                    label: 'APT',
                                    data: xValues1,
                                    borderColor: "rgba(7,250,142,1.0)",
                                    backgroundColor: "rgba(0,255,0,0.3)",
                                    color: "rgba(255,255,255,1.0)"
                                }
                            ]
                        };


                       const chart1 = new Chart("IdChart1", {
                            type: 'line',
                            data: data1,
                            options: {
                                responsive: true,
								maintainAspectRatio: true,
								scales: {
      y: {
        ticks: { color: 'white', beginAtZero: true }
      },
      x: {
        ticks: { color: 'white', beginAtZero: true }
      }
    },
                                plugins: {
                                    legend:{display:false},
                                    title: {
                                        display: true,
                                        text: 'Countries',
										color: "rgba(255,255,255,1.0)"
                                    }
                                }
                            },
                        });
 
	

	
	//chart2
	for (var key in vdict2){
		if (key!==""){
			xValues2.push(vdict2[key]);
			yValues2.push(key);}
	}
	                       
                    
    const labels2 = yValues2;
    const data2 = {
                   labels: labels2,
                   datasets: [
                                {
                                    label: 'First seen',
                                    data: xValues2,
                                    borderColor: "rgba(16,255,255,1.0)",
                                    backgroundColor: "rgba(0,255,0,0.3)",
                                    
                                }
                            ]
                        };


                       const chart2 = new Chart("IdChart2", {
                            type: 'line',
                            data: data2,
                            options: {
                                responsive: true,
								maintainAspectRatio: true,
								scales: {
      y: {
        ticks: { color: 'white', beginAtZero: true }
      },
      x: {
        ticks: { color: 'white', beginAtZero: true }
      }
    },
                                plugins: {
                                    legend:{display:false},
                                    title: {
                                        display: true,
                                        text: 'First seen',
										color: "rgba(255,255,255,1.0)"
                                    }
                                }
                            },
                        });
 

	//chart3
	var vdict3_sort = Object.keys(vdict3).map(function(key) { return [key, vdict3[key]];});
	vdict3_sort.sort(function(first, second) {  return second[1] - first[1];});


	for (let i = 0; i < 8; i++) {
		if (vdict3_sort[i][0]!==""){
			yValues3.push(vdict3_sort[i][0]);
			xValues3.push(vdict3_sort[i][1]);
			}
	}
	                       
                    
    const labels3 = yValues3;
    const data3 = {
                    labels: labels3,
                    datasets: [
                                {
                                    label: 'Targets',
                                    data: xValues3,
                                    borderColor: "rgba(255,16,101,1.0)",
                                    backgroundColor: "rgba(0,255,0,0.3)",
                                    
                                }
                            ]
                        };


                       const chart3 = new Chart("IdChart3", {
                            type: 'line',
                            data: data3,
                            options: {
                                responsive: true,
								maintainAspectRatio: true,
								scales: {
      y: {
        ticks: { color: 'white', beginAtZero: true }
      },
      x: {
        ticks: { color: 'white', beginAtZero: true }
      }
    },
                                plugins: {
                                    legend:{display:false},
                                    title: {
                                        display: true,
                                        text: 'Targets',
										color: "rgba(255,255,255,1.0)"
                                    }
                                }
                            },
                        });
						
						
	//chart4
	var vdict4_sort = Object.keys(vdict4).map(function(key) {  return [key, vdict4[key]];});
	vdict4_sort.sort(function(first, second) {  return second[1] - first[1];});


	for (let i = 0; i < 20; i++) {
		if (vdict4_sort[i][0]!==""){
			yValues4.push(vdict4_sort[i][0]);
			xValues4.push(vdict4_sort[i][1]);
			}
	}
	                       
                    
    const labels4 = yValues4;
    const data4 = {
                    labels: labels4,
                    datasets: [
                                {
                                    label: 'APT',
                                    data: xValues4,
                                    borderColor: "rgba(253,255,16,1.0)",
                                    backgroundColor: "rgba(0,255,0,0.3)",
                                    
                                }
                            ]
                        };


                       const chart4 = new Chart("IdChart4", {
                            type: 'doughnut',
                            data: data4,
                            options: {
                                responsive: true,
								maintainAspectRatio: true,
								
                                plugins: {
                                    legend:{display:false},
                                    title: {
                                        display: true,
                                        text: 'Target categories',
										color: "rgba(255,255,255,1.0)",
										
                                    }
                                }
                            },
                        });						
						
		
	//chart5
	var vdict5_sort = Object.keys(vdict5).map(function(key) {  return [key, vdict5[key]];});
	vdict5_sort.sort(function(first, second) {  return second[1] - first[1];});


	for (let i = 0; i < 12; i++) {
		if (vdict5_sort[i][0]!==""){
			yValues5.push(vdict5_sort[i][0]);
			xValues5.push(vdict5_sort[i][1]);}
    }
	                       
                   
const labels5 = yValues5;
const data5 = {
                labels: labels5,
                datasets: [
                                {
                                    label: 'Type of tools',
                                    data: xValues5,
                                    borderColor: "rgba(255,16,239,1.0)",
                                    backgroundColor: "rgba(30,30,30,0.3)",
                                    
                                }
                            ]
                        };


                       const chart5 = new Chart("IdChart5", {
                            type: 'doughnut',
                            data: data5,
                            options: {
                                responsive: true,
								maintainAspectRatio: true,
								
                                plugins: {
                                    legend:{display:false},
                                    title: {
                                        display: true,
                                        text: 'Type of tools',
										color: "rgba(255,255,255,1.0)",
										
                                    }
                                }
                            },
                        });						
						
			
	//chart6
	var vdict6_sort = Object.keys(vdict6).map(function(key) {  return [key, vdict6[key]];});
	vdict6_sort.sort(function(first, second) {  return second[1] - first[1];});


	for (let i = 0; i < 12; i++) {
		if (vdict6_sort[i][0]!==""){
			yValues6.push(vdict6_sort[i][0]);
			xValues6.push(vdict6_sort[i][1]);
			}
	}
	                       
                   
    const labels6 = yValues6;
    const data6 = {
                    labels: labels6,
                    datasets: [
                                {
                                    label: 'Tools',
                                    data: xValues6,
                                    borderColor: "rgba(33,7,231,1.0)",
                                    backgroundColor: "rgba(30,30,30,0.3)",
                                    
                                }
                            ]
                        };


                       const chart6 = new Chart("IdChart6", {
                            type: 'pie',
                            data: data6,
                            options: {
                                responsive: true,
								maintainAspectRatio: true,
								
                                plugins: {
                                    legend:{display:false},
                                    title: {
                                        display: true,
                                        text: 'Tools',
										color: "rgba(255,255,255,1.0)",
										
                                    }
                                }
                            },
                        });						

}


//relationship

var reldiv = document.getElementById("relPlaceHolder");

lst_tools=[];

APT_targets={};
APT_targetcategories={};
APT_ttp={};
APT_tools={};
Targets_APT={};
Tools_APT={};
Techniques_APT={};
lst_aptname=[];
lst_targets=[];

for (let i = 0; i < jdata.features.length; i++) {
	lst_aptname.push(jdata.features[i].properties["name"].trim());
	APT_targets[jdata.features[i].properties["name"].trim()]=jdata.features[i].properties["targets"];
	APT_targetcategories[jdata.features[i].properties["name"].trim()]=jdata.features[i].properties["target-category"];
    APT_ttp[jdata.features[i].properties["name"].trim()]=jdata.features[i].properties["TTP"];
	APT_tools[jdata.features[i].properties["name"].trim()]=jdata.features[i].properties["tools"];
}
	
lst_aptname.sort();


APTtoadd='<div id="relAPT"><h2>APT</h2>';


for (let i = 0; i < lst_aptname.length; i++){
	APTtoadd+='<h3 class="APTname">' + lst_aptname[i] + "</h3><br />";
	APTtoadd+='<span class="relAPTTargets"><h4 class="relTitle">Targets</h4>';
	APTtoadd+=APT_targets[lst_aptname[i]].join(", ")+"</span><br />";
	
	for (let i2 = 0; i2 < APT_targets[lst_aptname[i]].length; i2++)
	{
		if (  Targets_APT[APT_targets[lst_aptname[i]][i2]]=== undefined)
			{ 
			lst_targets.push(APT_targets[lst_aptname[i]][i2]);
			Targets_APT[APT_targets[lst_aptname[i]][i2]]= [lst_aptname[i]];  
			}
		else{ 
			Targets_APT[APT_targets[lst_aptname[i]][i2]].push(lst_aptname[i]);
			}
	
	}
	
	APTtoadd+='<span class="relAPTTargetCategories"><h4 class="relTitle2">Target categories</h4>';
	APTtoadd+=APT_targetcategories[lst_aptname[i]].join(", ")+"</span><br />";
	APTtoadd+='<span class="relAPTTechniques"><h4 class="relTitle">Techniques</h4>';
	for (let i2 = 0; i2 < APT_ttp[lst_aptname[i]].length; i2++)
	{
		APTtoadd+=APT_ttp[lst_aptname[i]][i2]["techniqueID"]+", ";
	}
	APTtoadd+="</span><br />";
	APTtoadd+='<span class="relAPTTools"><h4 class="relTitle">Tools</h4>';
	for (let i2 = 0; i2 < APT_tools[lst_aptname[i]].length; i2++)
	{
		APTtoadd+=APT_tools[lst_aptname[i]][i2]["value"]+", ";
		if (lst_tools.includes(APT_tools[lst_aptname[i]][i2]["value"])!== true)
		{ 
			lst_tools.push(APT_tools[lst_aptname[i]][i2]["value"]);  
		}

	}
	APTtoadd+="</span><br />";
	
}

APTtoadd+="</div></span><br />";

lst_targets.sort();
Targetstoadd='<div id="relTargets"><h2>Targets</h2>';

for (let i = 0; i < lst_targets.length; i++){
	Targetstoadd+='<h3 class="relTitle">'+lst_targets[i]+'</h3>';
	Targetstoadd+='<span class="relTargetsAPT">'+Targets_APT[lst_targets[i]].join(", ")+'</span>';
}
Targetstoadd+="</div>";



reldiv.innerHTML += APTtoadd + Targetstoadd;

var reldiv2 = document.getElementById("relPlaceHolder2");
reldiv2.innerHTML='<div class="relchk"><span class="relchkTitle">APT</span><label class="switch"><input type="checkbox" id="chkrelAPT" onclick="chkrelAPTclick()"><span class="slider"></span></label></div><div id="relAPTchk"><span class="relchkTitle">Targets</span><label class="switch"><input type="checkbox" id="chkrelAPT1" onclick="chkrelAPT1click()"><span class="slider"></span></label><span class="relchkTitle">Target categories</span><label class="switch"><input type="checkbox" id="chkrelAPT2" onclick="chkrelAPT2click()"><span class="slider"></span></label><span class="relchkTitle">Techniques</span><label class="switch"><input type="checkbox" id="chkrelAPT3" onclick="chkrelAPT3click()"><span class="slider"></span></label><span class="relchkTitle">Tools</span><label class="switch"><input type="checkbox" id="chkrelAPT4" onclick="chkrelAPT4click()"><span class="slider"></span></label></div><br /><div class="relchk"><span class="relchkTitle">Targets</span><label class="switch"><input type="checkbox" id="chkrelTargets" onclick="chkrelTargetsclick()"><span class="slider"></span></label></div>';


//fullstats

var fuldiv = document.getElementById("fulPlaceHolder");

divf1toadd="APTs: " + lst_aptname.length + "<br />";
divf1toadd+="Tools: " + lst_tools.length; + "<br />";

fuldiv.innerHTML += '<p class="info">'+divf1toadd + '</p>';


//others



var othdiv = document.getElementById("othPlaceHolder");

let apt = null;
var div='';


for (let i = 0; i < jdata.features.length; i++) {
	
    if (jdata.features[i].properties.country === "") 
	{
		apt = jdata.features[i];
        
		div+='<li><h2 class="APTnameclickable" onclick="toggleAPTDetails(this)"><i class="fa fa-caret-right"></i> '+ apt.properties["name"] +'</h2><div class="details">';
		if (apt.properties.description)
		{
			div+='<p class="info"><i class="fa fa-file-text-o"></i> <span class="infoTitle">Description</span><br />'+apt.properties.description+'</p>';
		}
	if (apt.properties["other-names"].length >0)
	{
		let onadd="";
		for (var on of apt.properties["other-names"]) 
		{
			onadd +=' '+on+',';
		}
		div+='<p class="info"><i class="fa fa-users"></i> <span class="infoTitle">Other names</span><br />'+onadd+'</p>';
	}
	
	if (apt.properties["first-seen"])
	{
		div+='<p class="info"><i class="fa fa-clock-o"></i> <span class="infoTitle">First seen</span><br />'+apt.properties["first-seen"]+'</p>';
	}
	if (apt.properties["sponsor"])
	{
		div+='<p class="info"><i class="fa fa-share-square-o"></i> <span class="infoTitle">Sponsor</span><br />'+apt.properties["sponsor"]+'</p>';
	}
	if (apt.properties.motivation)
	{
		div+='<p class="info"><i class="fa fa-angle-double-right"></i> <span class="infoTitle">Motivation</span><br />'+apt.properties.motivation+'</p>';
	}
	if (apt.properties.targets.length>0){
		let tadd="";
		for (var t of apt.properties.targets) 
			{
				tadd +=' <a href="#target=' + t +'" >'+t+'</a>,';
			}
		div+='<p class="info"><i class="fa fa-crosshairs"></i> <span class="infoTitle">Targets</span><br />'+tadd+'</p>';
	}
	
	if (apt.properties["target-category"].length>0)
	{
		let tadd="";
		for (var t of apt.properties["target-category"]) 
			{
				tadd +=' <a href="#targetcategory=' + t +'" >'+t+'</a>,';
			}
		div+='<p class="info"><i class="fa fa-industry"></i> <span class="infoTitle">Target categories</span><br />'+tadd+'</p>';
	
	}
	
	
	if (apt.properties["ext-links"].length>0)
	{
		let tadd="";
		let tmadd="";
		for (var t of apt.properties["ext-links"]) 
			{
				if (t.type=="malwaresample"){
					tmadd +=' <a href="' + t.url +'" >'
					tmadd +=t.description;
					tmadd +='</a><br /><br />';
				}
				else{
					tadd +=' <a href="' + t.url +'" >'
					if (t.description!== undefined){tadd +=t.url;}
					else{tadd +=t.description;}
					tadd +='</a><br /><br />';
				}
			}
		div+='<p class="info"><i class="fa fa-link"></i> <span class="infoTitle">External links</span><br />'+tadd+'</p>';
		div+='<p class="info"><i class="fa fa-link"></i> <span class="infoTitle">Malware samples</span><br />'+tmadd+'</p>';
	}
	
	
	
	
	
	if (apt.properties["tools"].length>0)
	{
		let tadd="";
		for (var t of apt.properties["tools"]) 
			{
			tadd +=' <a href="#tool=' + t.value +'" ><span class="infoTool">'+t.value+'</span> (category: ' + t.category +')</a><br />';
			if (t.type!== undefined){tadd +='type: '+ t.type.join(', ') +'<br />'}
			tadd +='<br />'+ t.description + '<br /><br />';
			for (var t2 of t.refs) 
				{
					tadd +=' <a href="'+ t2 +'" target="_blank">'+t2+'</a><br /><br />';
				}
					tadd +='<br />';
			}
		div+='<p class="info"><i class="fa fa-exclamation-triangle"></i> <span class="infoTitle">Tools</span><br />'+tadd+'</p>';
	}
	
	if (apt.properties["TTP"].length>0)
	{
		let tadd="";
		for (var t of apt.properties["TTP"]) 
			{
				tadd +=' <a href="https://attack.mitre.org/techniques/' + t.techniqueID.replace(".","/") +'/" target="_blank" ><span class="infoTTP">'+t.techniqueID+'</span></a><br />'
				if (t.comment!== undefined){tadd +=t.comment +'<br /><br />'}
		}
		div+='<p class="info"><i class="fa fa-cogs"></i> <span class="infoTitle">TTP</span><br />'+tadd+'</p>';
	}
	

	
	if (apt.properties.sources.length>0)
	{
		let sadd="";
		for (var s of apt.properties.sources) 
			{
				sadd +=s.name+ ', ' ;
			}
		div+='<p class="info"><i class="fa fa-book"></i> <span class="infoTitle">Sources</span><br />'+sadd+'</p>';
	}
div+='</div></li>';
}
}

othdiv.innerHTML += div;



	  
// tooltip
const tooltip = document.createElement("div");
tooltip.className = "tooltip";
document.body.appendChild(tooltip);


view.on("pointer-move", function(event) {
  view.hitTest(event).then(function(response) {
    
    if (response.results.length) {
      const graphic = response.results[0].graphic;
      
      if (graphic.geometry.type === "point" && graphic.attributes && graphic.attributes.name) {
        
        tooltip.style.left = event.x+5 + "px";
        tooltip.style.top = event.y-20 + "px";
        
        tooltip.textContent = graphic.attributes.name;
		
        
        tooltip.style.display = "block";
      }
    } else {
      
      tooltip.style.display = "none";
    }
  });
});



// search
const searchInput = document.createElement("input");
searchInput.type = "text";
searchInput.placeholder = "Search APT name";
searchInput.addEventListener("input", onSearchInput);

const searchInputRes = document.createElement("div");
searchInputRes.id="searchInputRes"
view.ui.add(searchInput, "top-right");
view.ui.add(searchInputRes, "top-right");

function onSearchInput() {
  
 	const searchText = searchInput.value.trim().toLowerCase();
	extremesLayer.definitionExpression = `LOWER(name) LIKE '%${searchText}%'`;
  
	extremesLayer.queryFeatures().then(function(results){
	var div="";
	if(searchText!==""){
 	
		var lst_apt=[];
		var lst_aptinmap=[];
		var lst_aptothers=[];
		for (let i = 0; i < jdata.features.length; i++) 
			{
	
			if (jdata.features[i].properties.name.toLowerCase().startsWith(searchText)) 
			{
				if (jdata.features[i].geometry!==undefined)
					{
					lst_aptinmap.push(jdata.features[i].properties.name);
					} 
				else 
					{
					lst_apt.push(jdata.features[i].properties.name);
					}
			
			}
			for (let i2 = 0; i2 < jdata.features[i].properties["other-names"].length; i2++) 
			{
				if (jdata.features[i].properties["other-names"][i2].toLowerCase().startsWith(searchText)) 
				{
					lst_aptothers.push(jdata.features[i].properties["other-names"][i2]);
				}
			}
		}
		lst_apt.sort();
		lst_aptinmap.sort();
		lst_aptothers.sort();
		if (lst_apt.length+lst_aptinmap.length+lst_aptothers.length>0)
		{
			div+="In map: ";
			for (let i = 0; i < lst_aptinmap.length; i++) 
			{
				div+=' <a href="#name=' + lst_aptinmap[i] +'" >'+lst_aptinmap[i] +'</a>,';
			}
			div+="<br /><br/>Not in map: ";
			for (let i = 0; i < lst_apt.length; i++) 
			{
				div+=' <a href="#name=' + lst_apt[i] +'" >'+lst_apt[i] +'</a>,';
			}
			div+="<br /><br/>Other names: ";
			for (let i = 0; i < lst_aptothers.length; i++) 
			{
				div+=' <a href="#name=' + lst_aptothers[i] +'" >'+lst_aptothers[i] +'</a>,';
			}
		} else{div+="No match.";}
	
	
		searchInputRes.style.display="block";
	}   
	else
	{	
		searchInputRes.style.display="none";
	}
	searchInputRes.innerHTML=div;
	});

}
  
document.getElementById("close-about").addEventListener("click", closeMenu);

document.getElementById("start-globe").addEventListener("click", function () {
	document.getElementById("chart-container").style.filter = "blur(0px)";
    closeMenu();
	onChart(jdata);
    
    });

document.getElementById("container").addEventListener("click", function (e) {
    if (e.target.id === "container") {
    closeMenu();
	onChart(jdata);
    
    }
});

function closeMenu() {
    document.getElementById("container").style.display = "none";
    view.container.style.filter = "blur(0px)";
	document.getElementById("chart-container").style.filter = "blur(0px)";
    }


      

let intro = true;
document.getElementById("about").addEventListener("click", function () {
    document.getElementById("container").style.display = "flex";
    view.container.style.filter = "blur(10px)";
	document.getElementById("chart-container").style.filter = "blur(10px)";
    if (intro) {
        document.getElementById("show-about").classList.remove("hidden");
        document.getElementById("show-intro").classList.add("hidden");
		document.getElementById("chart-container").style.filter = "";
		  
        intro = false;
    }
});
	  
	  
document.getElementById("others").addEventListener("click", function () {
	document.getElementById("others-container").style.display = "flex";
    });
document.getElementById("close-others").addEventListener("click", closeOthers);
	  
function closeOthers() {
    document.getElementById("others-container").style.display = "none";
    }
	  
document.getElementById("search").addEventListener("click", function () {
    document.getElementById("search-container").style.display = "flex";
    view.container.style.filter = "blur(10px)";
	document.getElementById("chart-container").style.filter = "blur(10px)";
    });
document.getElementById("close-search").addEventListener("click", closeSearch);
	  
function closeSearch() {
    document.getElementById("search-container").style.display = "none";
    view.container.style.filter = "blur(0px)";
	document.getElementById("chart-container").style.filter =  "blur(0px)";
    }
	  
document.getElementById("chart").addEventListener("click", function () {
    document.getElementById("chart-container").style.display = "flex";
    document.getElementById("chart-container").style.filter =  "blur(0px)";
	});
document.getElementById("close-chart").addEventListener("click", closeChart);
	  
function closeChart() {
    document.getElementById("chart-container").style.display = "none";
    }
	  
	  
document.getElementById("relationship").addEventListener("click", function () {
    document.getElementById("relationship-container").style.display = "flex";
    });
document.getElementById("close-relationship").addEventListener("click", closeRelationship);

function closeRelationship() {
    document.getElementById("relationship-container").style.display = "none";
    }


document.getElementById("malware").addEventListener("click", function () {
	var linkURL = "malware.html";
    window.open(linkURL, "_blank");
    });


view.ui.add("about", "bottom-left");
view.ui.add("maptitle", "top-left");
view.ui.add("others", "top-left");
view.ui.add("search", "top-left");
view.ui.add("chart", "top-left");
view.ui.add("relationship", "top-left");
view.ui.add("malware", "top-left");

function rotate() {
    if (!view.interacting) {
        const camera = view.camera.clone();
        camera.position.longitude -= 0.2;
        view.goTo(camera, { animate: false });
        requestAnimationFrame(rotate);
        }
    }

});
	

	
function DisplayPopUp(feature)
	{
	let apt = null;
	 
    for (let i = 0; i < jdata.features.length; i++) 
	{
		if (jdata.features[i].properties.uuid === feature.graphic.attributes.uuid) 
		{
			apt = jdata.features[i];
			break;
		}
    }

	

	var div='';
	div+='<div class="popupImage"><div class="Flag'+ apt.properties["image-url"].replace(".","") +'"></div></div>';
	div+='<div class="popupImageCaption">'+apt.properties["image-caption"]+'</div>';
	div+='<div class="popupDescription"><p class="info"><i class="fa fa-location-arrow"></i> <span class="infoTitle">Location</span><br />' + apt.properties.location + '</p>';
	if (apt.properties.description)
	{
		div+='<p class="info"><i class="fa fa-file-text-o"></i> <span class="infoTitle">Description</span><br />'+apt.properties.description+'</p>';
	}
	if (apt.properties["other-names"].length >0)
	{
		let onadd="";
		for (var on of apt.properties["other-names"]) 
			{
				onadd +=' ' + on +',';
			}
		div+='<p class="info"><i class="fa fa-users"></i> <span class="infoTitle">Other names</span><br />'+onadd+'</p>';
	}
	
	if (apt.properties["first-seen"])
	{
		div+='<p class="info"><i class="fa fa-clock-o"></i> <span class="infoTitle">First seen</span><br />'+apt.properties["first-seen"]+'</p>';
	}
	if (apt.properties["sponsor"])
	{
		div+='<p class="info"><i class="fa fa-share-square-o"></i> <span class="infoTitle">Sponsor</span><br />'+apt.properties["sponsor"]+'</p>';
	}
	if (apt.properties.motivation)
	{
		div+='<p class="info"><i class="fa fa-angle-double-right"></i> <span class="infoTitle">Motivation</span><br />'+apt.properties.motivation+'</p>';
		}
	if (apt.properties.targets.length>0)
	{
		let tadd="";
		for (var t of apt.properties.targets) 
			{
				tadd +=' <a href="#target=' + t +'" >'+t+'</a>,';
			}
		div+='<p class="info"><i class="fa fa-crosshairs"></i> <span class="infoTitle">Targets</span><br />'+tadd+'</p>';
	}
	
	if (apt.properties["target-category"].length>0)
	{
		let tadd="";
		for (var t of apt.properties["target-category"]) 
			{
				tadd +=' <a href="#targetcategory=' + t +'" >'+t+'</a>,';
		}
		div+='<p class="info"><i class="fa fa-industry"></i> <span class="infoTitle">Target categories</span><br />'+tadd+'</p>';
	}

	if (apt.properties["ext-links"].length>0)
	{
		let tadd="";
		let tmadd="";
		for (var t of apt.properties["ext-links"]) 
			{
				if (t.type=="malwaresample"){
					tmadd +=' <a href="' + t.url +'" target="_blank">'
					tmadd +=t.description;
					tmadd +='</a><br /><br />';
				}
				else{
					tadd +=' <a href="' + t.url +'" target="_blank">'
					if (t.description!== undefined){tadd +=t.url;}
					else{tadd +=t.description;}
					tadd +='</a><br /><br />';
				}
			}
		
		div+='<p class="info"><i class="fa fa-link"></i> <span class="infoTitle">External links</span><br />'+tadd+'</p>';
		div+='<p class="info"><i class="fa fa-link"></i> <span class="infoTitle">Malware samples</span><br />'+tmadd+'</p>';
	}
	
	
	
	if (apt.properties["tools"].length>0)
	{
		let tadd="";
		for (var t of apt.properties["tools"]) 
			{
			tadd +=' <a href="#tool=' + t.value +'" ><span class="infoTool">'+t.value+'</span> (category: ' + t.category +')</a><br />';
			if (t.type!== undefined){tadd +='type: '+ t.type.join(', ') +'<br />'}
			tadd +='<br />'+ t.description + '<br /><br />';
			for (var t2 of t.refs) 
				{
					tadd +=' <a href="'+ t2 +'" target="_blank">'+t2+'</a><br /><br />';
				}
					tadd +='<br />';
			}
		div+='<p class="info"><i class="fa fa-exclamation-triangle"></i> <span class="infoTitle">Tools</span><br />'+tadd+'</p>';
	}
	
	if (apt.properties["TTP"].length>0)
		{
		let tadd="";
		for (var t of apt.properties["TTP"]) 
			{
				tadd +=' <a href="https://attack.mitre.org/techniques/' + t.techniqueID.replace(".","/") +'/" target="_blank" ><span class="infoTTP">'+t.techniqueID+'</span></a><br />'
				if (t.comment!== undefined){tadd +=t.comment +'<br /><br />'}
			}
		div+='<p class="info"><i class="fa fa-cogs"></i> <span class="infoTitle">TTP</span><br />'+tadd+'</p>';
		}
	
	if (apt.properties.sources.length>0)
	{
		let sadd="";
		for (var s of apt.properties.sources) 
			{
				sadd +=s.name+ ', ' ;
			}
			div+='<p class="info"><i class="fa fa-book"></i> <span class="infoTitle">Sources</span><br />'+sadd+'</p>';
	}
	
	return div;
	}
	
	

	
function Search()
	{
	
		var srcdiv = document.getElementById("searchPlaceHolder");
		srcdiv.innerHTML="";
		var srcLocation = document.getElementById("searchLocation").value;
		var srcAPTname = document.getElementById("searchAPTname").value;
		var srcTools = document.getElementById("searchTool").value;
		var srcTarget = document.getElementById("searchTarget").value;
		var srcTargetcategory = document.getElementById("searchTargetcategory").value;


				
		var res=jdata.features;
		
		
	
		if (srcAPTname!=="")
		{
			let napt = null;
			for (let i = 0; i < jdata.features.length; i++) 
			{
		
				if (jdata.features[i].properties.name.toLowerCase() === srcAPTname.toLowerCase()) 
				{
					napt = jdata.features[i].properties.name;
					break;
				}
			}
		
			if(napt===null)
			{
				for (let i = 0; i < jdata.features.length; i++) 
				{
					for (let i2 = 0; i2 < jdata.features[i].properties["other-names"].length; i2++) 
					{
		
						if (jdata.features[i].properties["other-names"][i2].toLowerCase() === srcAPTname.toLowerCase()) 
						{
							napt = jdata.features[i].properties.name;
							break;
						}
					}
				}
			}
		
		res = res.filter(a => a.properties.name.toLowerCase() === napt.toLowerCase());
		
		}
		
		if (srcLocation!==""){
			res = res.filter(a => a.properties.location.toLowerCase() === srcLocation.toLowerCase());}
			
		
		if (srcTarget!==""){
			res = res.filter(a => a.properties.targets.some(x => x.toLowerCase() == srcTarget.toLowerCase()));}
			
		
		if (srcTargetcategory!==""){
			res = res.filter(a => a.properties["target-category"].some(x => x.toLowerCase() == srcTargetcategory.toLowerCase()));}
			
		if (srcTools!==""){
			res = res.filter(a => a.properties.tools.some(x => x.value.toLowerCase() == srcTools.toLowerCase()));}
		
			
		
		var div='';
		
		if (res.length>0)
		
		{
		for (var apt of res)
		{
			if(apt.properties.location!=="")
			{
				div+='<div class="popupImage"><img src="images/flags/'+ apt.properties["image-url"] +'" alt="' + apt.properties["image-caption"] + '"/></div>';
				div+='<div class="popupImageCaption">'+apt.properties["image-caption"]+'</div>';
				div+='<div class="popupDescription"><p class="info"><i class="fa fa-location-arrow"></i> <span class="infoTitle">Location</span><br />' + apt.properties.location + '</p>';
				}
			else
			{
			div+='<div class="popupDescription">';
			}	
				
				
			div+='<h2 class="APTname">'+ apt.properties["name"] +'</h2>';
			
			if (apt.properties.description)
			{
				div+='<p class="info"><i class="fa fa-file-text-o"></i> <span class="infoTitle">Description</span><br />'+apt.properties.description+'</p>';
			}
			if (apt.properties["other-names"].length >0)
			{
				let onadd="";
				for (var on of apt.properties["other-names"]) 
					{
						onadd +=' ' + on +',';
					}
				div+='<p class="info"><i class="fa fa-users"></i> <span class="infoTitle">Other names</span><br />'+onadd+'</p>';
			}
			
			if (apt.properties["first-seen"])
			{
				div+='<p class="info"><i class="fa fa-clock-o"></i> <span class="infoTitle">First seen</span><br />'+apt.properties["first-seen"]+'</p>';
			}
			if (apt.properties["sponsor"])
			{
				div+='<p class="info"><i class="fa fa-share-square-o"></i> <span class="infoTitle">Sponsor</span><br />'+apt.properties["sponsor"]+'</p>';
			}
			if (apt.properties.motivation)
			{
			div+='<p class="info"><i class="fa fa-angle-double-right"></i> <span class="infoTitle">Motivation</span><br />'+apt.properties.motivation+'</p>';
			}
			if (apt.properties.targets.length>0)
			{
				let tadd="";
				for (var t of apt.properties.targets) 
					{
					tadd +=' <a href="#target=' + t +'" >'+t+'</a>,';
					}
				div+='<p class="info"><i class="fa fa-crosshairs"></i> <span class="infoTitle">Targets</span><br />'+tadd+'</p>';
				}
		
			if (apt.properties["target-category"].length>0)
			{
				let tadd="";
				for (var t of apt.properties["target-category"]) 
					{
					tadd +=' <a href="#targetcategory=' + t +'" >'+t+'</a>,';
					}
			div+='<p class="info"><i class="fa fa-industry"></i> <span class="infoTitle">Target categories</span><br />'+tadd+'</p>';
			}
		
		
			if (apt.properties["ext-links"].length>0)
			{
			
			let tadd="";
			let tmadd="";
			for (var t of apt.properties["ext-links"]) 
				{
					if (t.type=="malwaresample"){
						tmadd +=' <a href="' + t.url +'" target="_blank">'
						tmadd +=t.description;
						tmadd +='</a><br /><br />';
					}
					else{
						tadd +=' <a href="' + t.url +'" target="_blank">'
						if (t.description!== undefined){tadd +=t.url;}
						else{tadd +=t.description;}
						tadd +='</a><br /><br />';
					}
				}
		
			div+='<p class="info"><i class="fa fa-link"></i> <span class="infoTitle">External links</span><br />'+tadd+'</p>';
			div+='<p class="info"><i class="fa fa-link"></i> <span class="infoTitle">Malware samples</span><br />'+tmadd+'</p>';
		
			
			
			
			}
		
			if (apt.properties["tools"].length>0)
			{
				let tadd="";
				for (var t of apt.properties["tools"]) 
					{
					tadd +=' <a href="#tool=' + t.value +'" ><span class="infoTool">'+t.value+'</span> (category: ' + t.category +')</a><br />';
					if (t.type!== undefined){tadd +='type: '+ t.type.join(', ') +'<br />'}
					tadd +='<br />'+ t.description + '<br /><br />';
					for (var t2 of t.refs) 
						{
							tadd +=' <a href="'+ t2 +'" target="_blank">'+t2+'</a><br /><br />';
						}
						tadd +='<br />';
					}
			div+='<p class="info"><i class="fa fa-exclamation-triangle"></i> <span class="infoTitle">Tools</span><br />'+tadd+'</p>';
			}
		
			if (apt.properties["TTP"].length>0)
			{
				let tadd="";
				for (var t of apt.properties["TTP"]) 
					{
					tadd +=' <a href="https://attack.mitre.org/techniques/' + t.techniqueID.replace(".","/") +'/" target="_blank" ><span class="infoTTP">'+t.techniqueID+'</span></a><br />'
					if (t.comment!== undefined){tadd +=t.comment +'<br /><br />'}
					}
				div+='<p class="info"><i class="fa fa-cogs"></i> <span class="infoTitle">TTP</span><br />'+tadd+'</p>';
			}
		
		
		
			if (apt.properties.sources.length>0)
			{
				let sadd="";
				for (var s of apt.properties.sources) 
				{
					sadd +=s.name+ ', ' ;
				}
				div+='<p class="info"><i class="fa fa-book"></i> <span class="infoTitle">Sources</span><br />'+sadd+'</p>';
			}
				
			div+='</div><br /><br /><br /><br />';
		
		
		}
		
		
		
		} else {div="No match.";}
		
	srcdiv.innerHTML=div;
	
	
}
	
	});

  </script>
</head>
<body>
  <div id="viewDiv">
    <div id="about">About APTMAP</div>
	<div id="maptitle"><img src="images/aptmap.png" /></div>
	
	<div id="others"><h3>Other APTs not in map</h3></div>
	<div id="search"><h3>Search</h3></div>
	<div id="chart"><h3>Charts</h3></div>
	<div id="relationship"><h3>Relationship</h3></div>
	<div id="malware"><h3>APT Malware</h3></div>
	
	
  </div>
  <div id="container">
  
    <div id="introDiv">
      <img src="images/aptmap.png" />
      <div id="show-intro">
        <p>An Advanced Persistent Threat (APT) is a stealthy computer network threat actor, nation state, state-sponsored group or non-state sponsored groups conducting large-scale targeted intrusions for specific goals, which gains unauthorized access to a computer network and remains undetected for an extended period.
        </p>
		<p>Attribution is a very complex issue. This map is based on data from different sources (vendor, studies, reports, ...) and it is not a reliable source. The majority of the mappings rely on the findings in a single incident analysis. Groups often change their toolsets or exchange them with other groups. This makes attribution of certain operations extremely difficult. Information published here may be wrong, outdated, or may change based on evolving information.</p>
        <p>Primary sources: <a href="https://www.misp-project.org/" target="blank_">MISP</a>, <a href="https://attack.mitre.org/" target="blank_">MITRE</a>, <a href="https://www.etda.or.th/th/" target="blank_">ETDA</a>, <a href="https://www.vx-underground.org/" target="blank_">VX-Underground</a></p>
		<p>ALL DOCUMENTS AND THE INFORMATION CONTAINED THEREIN ARE PROVIDED ON AN "AS IS" BASIS</p>
		<p>Project: <strong style="color:rgb(253, 255, 16);">Andrea Cristaldi</strong> <a href="https://github.com/andreacristaldi/APTmap" target="blank_">GitHub</a>, <a href="https://www.linkedin.com/in/andreacristaldi/" target="blank_">Linkedin</a>, <a href="https://www.cybersec4.com" target="blank_">Cybersec4</a>
		<p>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" target="blank_">Creative Commons Attribution 4.0 International License</a>.</p>
		<button id="start-globe">Go to map</button>
      </div>
      <div id="show-about" class="hidden">
	  <p>An Advanced Persistent Threat (APT) is a stealthy computer network threat actor, nation state, state-sponsored group or non-state sponsored groups conducting large-scale targeted intrusions for specific goals, which gains unauthorized access to a computer network and remains undetected for an extended period.
        </p>
		<p>Attribution is a very complex issue. This map is based on data from different sources (vendor, studies, reports, ...) and it is not a reliable source. The majority of the mappings rely on the findings in a single incident analysis. Groups often change their toolsets or exchange them with other groups. This makes attribution of certain operations extremely difficult. Information published here may be wrong, outdated, or may change based on evolving information.</p>
        <p>Primary sources: <a href="https://www.misp-project.org/" target="blank_">MISP</a>, <a href="https://attack.mitre.org/" target="blank_">MITRE</a>, <a href="https://www.etda.or.th/th/" target="blank_">ETDA</a>, <a href="https://www.vx-underground.org/" target="blank_">VX-Underground</a></p>
		<ol id="fulPlaceHolder">
		</ol>
		<p>ALL DOCUMENTS AND THE INFORMATION CONTAINED THEREIN ARE PROVIDED ON AN "AS IS" BASIS</p>
        <p>Project: <strong style="color:rgb(253, 255, 16);">Andrea Cristaldi</strong> <a href="https://github.com/andreacristaldi/APTmap" target="blank_">GitHub</a>, <a href="https://www.linkedin.com/in/andreacristaldi/" target="blank_">Linkedin</a>, <a href="https://www.cybersec4.com" target="blank_">Cybersec4</a>
		<p>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" target="blank_">Creative Commons Attribution 4.0 International License</a>.</p>
		<button id="close-about" class="esri-icon-close"></button>
        </div>
	   
    </div>
  </div>
  <div id="others-container">
  <button id="close-others" class="esri-icon-close"></button>
		<div class="PanelContainer"><img src="images/aptmap.png" />        
		<h1>Other APTs not in map</h1>
		<ol id="othPlaceHolder">
		</ol>
		
		</div>
		
  </div>
  
 
  
    <div id="relationship-container">
  <button id="close-relationship" class="esri-icon-close"></button>
		<div><img src="images/aptmap.png" />        
		<h1>Relationship</h1>
		<div id="relPlaceHolder2"></div>
		<ol id="relPlaceHolder">
		</ol>
		<script>
function chkrelAPTclick() {
  
  var checkBox = document.getElementById("chkrelAPT");
  var box2 = document.getElementById("relAPT");
  if (checkBox.checked == true)
  {
	box2.style.display = 'block';
  } 
  else 
  {
    box2.style.display = 'none';
  }
}

function chkrelAPT1click() {
  
  var checkBox = document.getElementById("chkrelAPT1");
  var boxes = document.querySelectorAll('.relAPTTargets');


  if (checkBox.checked == true)
  {
	boxes.forEach(box => {  box.style.display = 'block';});
  } 
  else 
  {
    boxes.forEach(box => {  box.style.display = 'none';});
  }
}


function chkrelAPT2click() {
  
  var checkBox = document.getElementById("chkrelAPT2");
  var boxes = document.querySelectorAll('.relAPTTargetCategories');


  if (checkBox.checked == true){
    boxes.forEach(box => {  box.style.display = 'block';});
  
  } else {
    boxes.forEach(box => {  box.style.display = 'none';});
	
  }
}

function chkrelAPT3click() {
  
  var checkBox = document.getElementById("chkrelAPT3");
  var boxes = document.querySelectorAll('.relAPTTechniques');


  if (checkBox.checked == true){
    boxes.forEach(box => {  box.style.display = 'block';});
  
  } else {
    boxes.forEach(box => {  box.style.display = 'none';});
	
  }
}

function chkrelAPT4click() {
  
  var checkBox = document.getElementById("chkrelAPT4");
  var boxes = document.querySelectorAll('.relAPTTools');


  if (checkBox.checked == true){
    boxes.forEach(box => {  box.style.display = 'block';});
  
  } else {
    boxes.forEach(box => {  box.style.display = 'none';});
	
  }
}

function chkrelTargetsclick(){
var checkBox = document.getElementById("chkrelTargets");
   var box = document.getElementById("relTargets");
   if (checkBox.checked == true){
   
   box.style.display = 'block';
  } else {
     
   box.style.display = 'none';
  }
}

function btnSearchClick()
{
window.location.hash="#";
if (document.getElementById("searchAPTname").value!==""){window.location.hash+='name='+document.getElementById("searchAPTname").value +'&';
} 
if (document.getElementById("searchTarget").value!==""){window.location.hash+='target='+document.getElementById("searchTarget").value+'&';
}
if (document.getElementById("searchTargetcategory").value!==""){window.location.hash+='targetcategory='+document.getElementById("searchTargetcategory").value+'&';
}
if (document.getElementById("searchTool").value!==""){window.location.hash+='tool='+document.getElementById("searchTool").value+'&';
} 
if (document.getElementById("searchLocation").value!==""){window.location.hash+='location='+document.getElementById("searchLocation").value+'&';}

if (window.location.hash==="#"){window.location.hash="";}

}	

function clearSearch()
{
	document.getElementById("searchAPTname").value="";
	document.getElementById("searchTarget").value="";
	document.getElementById("searchTargetcategory").value="";
	document.getElementById("searchTool").value="";
	document.getElementById("searchLocation").value="";

}
		
		
		</script>
		</div>
		
  </div>
  
  <div id="search-container">
  <div id="searchDiv">
  <button id="close-search" class="esri-icon-close"></button>
		<div><img src="images/aptmap.png" /> </div> 
		<div>		
		<h1>Search</h1>
		<div id"searchPnl">APT Name: <input type="text" id="searchAPTname" name="searchAPTname"><br><br>
		Location: <input type="text" id="searchLocation" name="searchLocation"><br><br>
		Target: <input type="text" id="searchTarget" name="searchTarget"><br><br>
		Target category: <input type="text" id="searchTargetcategory" name="searchTargetcategory"><br><br>
		Tool: <input type="text" id="searchTool" name="searchTool"><br><br>
		<input type="button" id="btnsearch" name="btnsearch" value="Search" onclick="btnSearchClick()">
		<button onclick="clearSearch()">Clear</button>
		</div>
		<ol id="searchPlaceHolder">
		</ol>
		</div>
	   </div>
    </div>
	<div id="chart-container">
  <div id="chartDiv">
  <button id="close-chart" class="esri-icon-close"></button>
		
		<div>		
		<canvas id="IdChart1" ></canvas>
		<canvas id="IdChart2" ></canvas>
		<canvas id="IdChart3" ></canvas>
		<canvas id="IdChart4" ></canvas>
		<canvas id="IdChart5" ></canvas>
		<canvas id="IdChart6" ></canvas>
		</div>
		
		</div>
	   </div>
    </div>
	</div>
  </div>
 <script>
 setTimeout(function(){
 
 if (window.location.hash!=="") {
	document.getElementById("search").click();
	
	document.getElementById("searchAPTname").value="";
	document.getElementById("searchTarget").value="";
	document.getElementById("searchTargetcategory").value="";
	document.getElementById("searchTool").value="";
	document.getElementById("searchLocation").value="";
	console.log(window.location.hash.split("#"));
	console.log(window.location.hash.split("#")[1].split("&"));
	for (var h of window.location.hash.split("#")[1].split("&")){
	console.log(h);
		if (h.split("=")[0]==="name"){
			document.getElementById("searchAPTname").value=decodeURIComponent(h.split("=")[1]);
		}
		if (h.split("=")[0]==="target"){
			document.getElementById("searchTarget").value=decodeURIComponent(h.split("=")[1]);
		}
		if (h.split("=")[0]==="targetcategory"){
			document.getElementById("searchTargetcategory").value=decodeURIComponent(h.split("=")[1]);
		}
		if (h.split("=")[0]==="tool"){
			document.getElementById("searchTool").value=decodeURIComponent(h.split("=")[1]);
		}
		if (h.split("=")[0]==="location"){
			document.getElementById("searchLocation").value=decodeURIComponent(h.split("=")[1]);
		}
		
	}
	
	

Search();
	}
}, 6000);
 
 </script>
</body>
</html>